# nginx TLS 1.3 focused configuration
# Place this file in your nginx conf.d or include it from your main nginx.conf
# Replace /etc/ssl/certs/yourdomain.crt and /etc/ssl/private/yourdomain.key
# Replace /etc/ssl/certs/chain.pem with your full chain (certificate + intermediates)

# Notes:
# - Requires nginx built with OpenSSL 1.1.1+ (for TLS 1.3 support).
# - TLS 1.3 cipher control via OpenSSL; nginx newer versions support ssl_conf_command to set TLS1.3 ciphers.
# - This config opts for TLS 1.3-only. If you need TLS 1.2 fallback for older clients, see the commented section below.

# Example usage in main nginx.conf:
# http {
#   include /etc/nginx/conf.d/*.conf;
#   include kube/nginx/tls-1.3.conf;
# }

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  listen [::]:80;
  server_name example.com www.example.com;  # <-- replace

  # Redirect all HTTP to HTTPS
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name agromarket.com www.agromarket.com;

  # Paths to your certificate and private key
  ssl_certificate /etc/ssl/certs/savi.crt;         # fullchain (cert + intermediates)
  ssl_certificate_key /etc/ssl/private/savi.key;   # private key
  ssl_trusted_certificate /etc/ssl/certs/chain.pem;      # trusted chain for OCSP stapling

  # TLS protocols: TLSv1.3 only
  ssl_protocols TLSv1.3;

  # TLS 1.3 ciphers (OpenSSL 1.1.1+). If nginx supports it, you can force TLS1.3 ciphers via ssl_conf_command.
  # Uncomment the ssl_conf_command below if your nginx supports it (>=1.19.10 with OpenSSL 1.1.1+ or compiled accordingly).
  # ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;

  # For TLS 1.2 (if enabling fallback), use a safe modern cipher list: see commented section at end.
  ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';

  ssl_prefer_server_ciphers off;   # Recommended for TLS1.3 (server preference not used by TLS1.3)

  # Session and performance
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1d;
  ssl_session_tickets off;         # disable session tickets unless you manage key rotation

  # OCSP stapling for better certificate revocation checking
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;

  # Diffie-Hellman parameter (not strictly needed for TLS1.3 but fine to include)
  # Generate with: openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
  ssl_dhparam /etc/ssl/certs/dhparam.pem;

  # Security headers
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
  add_header X-Frame-Options "DENY" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  add_header X-XSS-Protection "1; mode=block" always;

  # Logging and root (adjust as needed)
  access_log /var/log/nginx/example.access.log;
  error_log /var/log/nginx/example.error.log;

  root /var/www/html; # adjust to your app
  index index.html index.htm;

  # Example proxy pass to upstream app
  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_pass http://localhost:3000; # adjust your upstream
  }

  # Optional: /.well-known for ACME (Let's Encrypt)
  location ^~ /.well-known/acme-challenge/ {
    default_type "text/plain";
    root /var/www/letsencrypt;
  }
}

# --- Optional: TLS 1.2 + 1.3 fallback (uncomment TLSv1.2 if needed) ---
# If you need to support older clients, change `ssl_protocols TLSv1.3;` to:
# ssl_protocols TLSv1.3 TLSv1.2;
# And set a modern TLS1.2 cipher list (the ssl_ciphers line above is a good starting point).

# --- Testing ---
# Test nginx configuration and reload:
#   (Linux)
#   sudo nginx -t && sudo systemctl reload nginx
#   (Windows - if using nginx on Windows)
#   nginx -t && nginx -s reload

# Test TLS 1.3 support with openssl:
#   openssl s_client -connect example.com:443 -tls1_3 -servername example.com
# To test that TLS 1.2 is rejected (if configured TLS1.3-only):
#   openssl s_client -connect example.com:443 -tls1_2 -servername example.com

# --- Important notes ---
# 1) Ensure your nginx binary is built against OpenSSL 1.1.1 or newer. You can check:
#    nginx -V 2>&1 | findstr "OpenSSL"
#    (or: nginx -V 2>&1 | grep OpenSSL)
# 2) Use real certificate files and provide full chain for OCSP stapling (ssl_trusted_certificate).
# 3) If you use a reverse proxy (cloud load balancer) that terminates TLS, ensure it supports TLS1.3.
# 4) If you want to pin TLS1.3 ciphers explicitly and your nginx supports it, prefer using ssl_conf_command like:
#    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
#    Note: this requires nginx + OpenSSL support (check nginx changelog / build options).

# End of file

